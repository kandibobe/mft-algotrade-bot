# Спецификация Риск-менеджмента Stoic Citadel

## 1. Резюме
Этот документ определяет комплексную систему управления рисками для MFT-бота Stoic Citadel. Система спроектирована для предотвращения катастрофических потерь (Ruin) при максимизации геометрического роста (Kelly) в различных рыночных режимах.

## 2. Иерархия Рисков
Фреймворк работает на трех строгих уровнях. Нижние уровни не могут переопределять правила верхних уровней.

1.  **Системный Уровень (Circuit Breaker)**: "Можем ли мы торговать вообще?" (Проверка здоровья системы).
2.  **Портфельный Уровень (Корреляция и Аллокация)**: "Можем ли мы добавить больше риска?" (Проверка концентрации).
3.  **Торговый Уровень (Ликвидация и Размер)**: "Безопасна ли эта конкретная сделка?"

## 3. Ключевые Компоненты и Правила

### A. Защита от Ликвидации (Liquidation Guard)
**Цель**: Предотвратить принудительную ликвидацию биржей до срабатывания стоп-лосса.
**Правило**: `StopLoss` должен быть достигнут раньше, чем `LiquidationPrice` с запасом прочности 20%.
**Формула**: `|Entry - StopLoss| < |Entry - LiqPrice| * 0.8`
**Действие**: Если правило нарушено, сделка отклоняется или кредитное плечо (leverage) снижается.

### B. Контроль Корреляции (Correlation Guard)
**Цель**: Предотвратить концентрацию риска в одном факторе (например, падение всего крипторынка одновременно).
**Правило**: Максимальный коэффициент корреляции портфеля `0.7`.
**Действие**: Отклонять новые лонг-позиции, если средняя корреляция существующих позиций > 0.7.

### C. Автоматический Выключатель по Волатильности (Volatility Circuit Breaker)
**Цель**: Остановить торговлю во время экстремальных рыночных событий.
**Правило**: Остановить торговлю, если:
-   Дневная просадка (Daily Drawdown) > 5%
-   Общая просадка (Total Drawdown) > 20%
-   Волатильность (ATR%) > 8% (Адаптивный порог)

### D. Режим-Адаптивный Сайзинг (Regime-Adaptive Sizing)
**Цель**: Регулировать риск в зависимости от "погоды" на рынке.

| Режим (Regime) | Условие | Размер Позиции | Плечо | Стоп-лосс |
| :--- | :--- | :--- | :--- | :--- |
| **Трендовый** | Hurst > 0.6 | 100% | 1x-3x | Стандартный (2x ATR) |
| **Флэт (Ranging)** | Hurst < 0.4 | 80% | 1x | Узкий (1.5x ATR) |
| **Высокая Волатильность** | Vol Rank > 80% | 50% | 1x (Без плеча) | Широкий (3x ATR) |
| **Шум (Noise)** | 0.45 < Hurst < 0.55 | 0% | 0x | Не торгуем |

## 4. Детали Реализации

### Конфигурация (`unified_config.py`)
```yaml
risk:
  max_position_pct: 0.10       # Макс 10% на сделку
  max_portfolio_risk: 0.02     # Макс 2% риска капитала на сделку
  max_drawdown_pct: 0.20       # 20% жесткая остановка (Hard Stop)
  liquidation_buffer: 0.20     # 20% буфер до ликвидации
  max_correlation: 0.70        # Максимальная корреляция
```

### Логика Интеграции (`StoicRiskMixin`)
`StoicRiskMixin` работает как посредник (middleware) между Freqtrade и кастомным `RiskManager`.
1.  **Перед сделкой (Pre-Trade)**: Вызывает `RiskManager.evaluate_trade()` перед каждым входом.
2.  **Сайзинг**: Переопределяет метод `custom_stake_amount`, применяя правила режима и лимиты портфеля.
3.  **Мониторинг**: Синхронизирует состояние кошелька и сделок с `RiskManager` на каждой итерации.

## 5. Математическое Обоснование

### Буфер Ликвидации
Дано `L` (Плечо) и `MMR` (Ставка поддерживающей маржи ~0.5%), ликвидация происходит примерно на уровне `Entry * (1 - 1/L)`.
При `L=3`, Ликвидация на -33%.
Если Стоп-лосс на -5%, Запас прочности = `33% / 5% = 6.6x`. **Безопасно**.
При `L=10`, Ликвидация на -10%. Стоп-лосс на -5%. Запас = `10% / 5% = 2x`. **На грани**.
При `L=20`, Ликвидация на -5%. Стоп-лосс на -5%. **Мгновенный риск ликвидации**.

### Влияние Корреляции
Дисперсия портфеля `Vp` растет линейно с количеством активов, если корреляция `rho` стремится к 1.
Ограничение `rho < 0.7` гарантирует, что диверсификация реально работает и снижает общий риск.

## 6. Будущие Улучшения
-   **Интеграция HRP**: Использование Hierarchical Risk Parity для автоматической ребалансировки весов (сейчас они статичны).
-   **Хеджирование Опционами**: Покупка глубоких OTM путов, когда Режим = Высокая Волатильность.
