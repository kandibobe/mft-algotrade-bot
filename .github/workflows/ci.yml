name: Stoic Citadel CI/CD

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ==============================================================================
  # CODE QUALITY & LINTING
  # ==============================================================================

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy

      - name: ğŸ¨ Check code formatting (Black)
        run: |
          black --check --line-length 88 user_data/strategies/ scripts/ || (
            echo "âŒ Code formatting issues found!"
            echo "Run: make format"
            exit 1
          )

      - name: ğŸ” Lint with flake8
        run: |
          flake8 --max-line-length=88 --extend-ignore=E203,W503 \
            --count --statistics \
            user_data/strategies/ scripts/ || (
            echo "âŒ Linting issues found!"
            exit 1
          )

      - name: ğŸ”¬ Type checking (MyPy)
        continue-on-error: true  # Type checking is advisory for now
        run: |
          mypy --ignore-missing-imports \
            --python-version 3.11 \
            user_data/strategies/ scripts/ || echo "âš ï¸ Type issues found (non-blocking)"

  # ==============================================================================
  # SECURITY SCANNING
  # ==============================================================================

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ Run security scan (Bandit)
        continue-on-error: true
        run: |
          pip install bandit
          bandit -r user_data/strategies/ scripts/ -ll || echo "âš ï¸ Security warnings (non-blocking)"

      - name: ğŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ==============================================================================
  # UNIT TESTS
  # ==============================================================================

  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock pandas numpy ta-lib

      - name: ğŸ§ª Run unit tests
        run: |
          pytest tests/test_strategies/ \
            -v \
            --tb=short \
            --cov=user_data/strategies \
            --cov-report=xml \
            --cov-report=term \
            -m "not slow" || (
            echo "âŒ Unit tests failed!"
            exit 1
          )

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-stoic-citadel
          fail_ci_if_error: false

  # ==============================================================================
  # INTEGRATION TESTS
  # ==============================================================================

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-mock pandas numpy ta-lib

      - name: ğŸ”— Run integration tests
        run: |
          pytest tests/test_integration/ \
            -v \
            --tb=short \
            -m "integration and not slow" || (
            echo "âŒ Integration tests failed!"
            exit 1
          )

  # ==============================================================================
  # DOCKER BUILD
  # ==============================================================================

  docker:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Jupyter image
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile.jupyter
          push: false
          tags: stoic-citadel-jupyter:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Verify Docker Compose
        run: |
          docker-compose config > /dev/null || (
            echo "âŒ Docker Compose configuration invalid!"
            exit 1
          )

  # ==============================================================================
  # STRATEGY VALIDATION
  # ==============================================================================

  validate-strategy:
    name: Strategy Validation
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Freqtrade dependencies
        run: |
          pip install pandas numpy ta-lib freqtrade

      - name: âœ… Validate strategy syntax
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'user_data/strategies')
          from StoicEnsembleStrategy import StoicEnsembleStrategy
          strategy = StoicEnsembleStrategy()
          assert strategy.INTERFACE_VERSION == 3
          print('âœ… Strategy validation passed!')
          "

      - name: ğŸ” Check risk parameters
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'user_data/strategies')
          from StoicEnsembleStrategy import StoicEnsembleStrategy
          strategy = StoicEnsembleStrategy()

          # Verify risk limits
          assert strategy.stoploss == -0.05, 'Stoploss not at -5%'
          assert strategy.trailing_stop is True, 'Trailing stop not enabled'
          assert len(strategy.protections) > 0, 'No protections configured'

          print('âœ… Risk parameters validated!')
          "

  # ==============================================================================
  # CONFIGURATION VALIDATION
  # ==============================================================================

  validate-config:
    name: Config Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install jsonschema

      - name: âœ… Validate JSON configs
        run: |
          python -c "
          import json
          import os

          config_files = [
              'user_data/config/config_dryrun.json',
              'user_data/config/config_production.json'
          ]

          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file, 'r') as f:
                      config = json.load(f)
                      print(f'âœ… {config_file} is valid JSON')
              else:
                  print(f'âš ï¸ {config_file} not found (skipping)')
          "

      - name: ğŸ”’ Check for hardcoded secrets
        run: |
          if grep -r -i "api_key.*=" user_data/config/ || \
             grep -r -i "secret.*=" user_data/config/ || \
             grep -r -i "password.*=" user_data/config/; then
            echo "âŒ Hardcoded secrets found in config files!"
            exit 1
          fi
          echo "âœ… No hardcoded secrets found"

  # ==============================================================================
  # QUICK BACKTEST (Smoke Test)
  # ==============================================================================

  backtest-smoke:
    name: Quick Backtest
    runs-on: ubuntu-latest
    needs: [validate-strategy]
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build containers
        run: |
          docker-compose build freqtrade

      - name: ğŸ“¥ Download sample data
        run: |
          mkdir -p user_data/data/binance
          # In real scenario, we'd download minimal data here
          echo "Sample data would be downloaded here"

      - name: ğŸ§ª Run quick backtest (smoke test)
        continue-on-error: true
        run: |
          echo "Quick backtest would run here with minimal data"
          echo "This ensures the strategy can execute without errors"

  # ==============================================================================
  # FINAL STATUS CHECK
  # ==============================================================================

  all-checks-passed:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, security, test, integration, docker, validate-strategy, validate-config]

    steps:
      - name: ğŸ‰ Success
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘            âœ… ALL CI/CD CHECKS PASSED SUCCESSFULLY! âœ…              â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘                   STOIC CITADEL IS READY                           â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ==============================================================================
  # AUTO-DEPLOY (Only on main branch)
  # ==============================================================================

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [all-checks-passed]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy notification
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "In a real scenario, this would:"
          echo "  1. Build production Docker images"
          echo "  2. Push to Docker registry"
          echo "  3. Deploy to VPS/cloud"
          echo "  4. Run health checks"
          echo "  5. Send notifications"

      - name: âœ… Deployment complete
        run: |
          echo "âœ… Production deployment completed!"
