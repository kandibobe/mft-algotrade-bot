version: '3'
services:
  freqtrade:
    # Используем сборку из текущей папки (наш Dockerfile)
    build:
      context: .
      dockerfile: Dockerfile
    image: stoic_citadel:latest
    container_name: stoic_freqtrade
    restart: unless-stopped
    volumes:
      # Монтируем конфиги и данные
      - ./user_data:/freqtrade/user_data
      # КРИТИЧНО: Монтируем исходный код src внутрь контейнера
      - ./src:/freqtrade/user_data/src
    ports:
      - "127.0.0.1:8080:8080"
    # Исправлена команда: config.json -> config_production.json
    command: >
      trade
      --logfile /freqtrade/user_data/logs/freqtrade.log
      --db-url sqlite:////freqtrade/user_data/tradesv3.sqlite
      --config /freqtrade/user_data/config/config_production.json
      --strategy StoicEnsembleStrategyV2
    networks:
      - stoic_network
    env_file:
      - .env

  frequi:
    image: freqtradeorg/frequi:latest
    container_name: stoic_frequi
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:8080"
    environment:
      - VITE_API_URL=http://freqtrade:8080
    depends_on:
      freqtrade:
        condition: service_started
    networks:
      - stoic_network

  # Jupyter и Postgres пока можно оставить как есть или закомментировать, 
  # если они не нужны прямо сейчас, чтобы ускорить первый запуск.
  # Я оставил их, но если будут ошибки ресурсов - можно временно отключить.

networks:
  stoic_network:
    driver: bridge