# ==============================================================================
# STOIC CITADEL - КОНФИГУРАЦИЯ КОННЕКТОРОВ
# ==============================================================================
#
# Централизованная конфигурация для всех внешних подключений:
# - Exchange коннекторы (Binance, Bybit, etc.)
# - Database коннекторы (PostgreSQL, Redis)
# - WebSocket подключения
# - API эндпоинты
#
# ==============================================================================

# ------------------------------------------------------------------------------
# EXCHANGE CONNECTORS (Биржи)
# ------------------------------------------------------------------------------
exchanges:
  binance:
    enabled: true
    name: "binance"
    type: "spot"  # spot, futures, margin
    
    # API Settings
    api:
      testnet: false
      sandbox: false
      rate_limit: true
      timeout: 30000  # milliseconds
      
    # Rate Limiting
    rate_limits:
      requests_per_second: 10
      orders_per_second: 5
      weight_per_minute: 1200
      
    # Connection Pool
    connection_pool:
      min_connections: 2
      max_connections: 10
      idle_timeout: 300  # seconds
      
    # Retry Strategy
    retry:
      max_attempts: 5
      initial_delay: 1.0  # seconds
      max_delay: 60.0
      backoff_multiplier: 2.0
      
    # WebSocket Settings
    websocket:
      enabled: true
      url: "wss://stream.binance.com:9443/ws"
      ping_interval: 30
      ping_timeout: 10
      reconnect_delay: 5
      max_reconnect_attempts: 10
      
    # Supported Features
    features:
      ohlcv: true
      orderbook: true
      trades: true
      ticker: true
      balance: true
      create_order: true
      cancel_order: true
      fetch_order: true
      
  bybit:
    enabled: false
    name: "bybit"
    type: "spot"
    
    api:
      testnet: false
      sandbox: false
      rate_limit: true
      timeout: 30000
      
    rate_limits:
      requests_per_second: 5
      orders_per_second: 3
      weight_per_minute: 120
      
    connection_pool:
      min_connections: 1
      max_connections: 5
      idle_timeout: 300
      
    retry:
      max_attempts: 5
      initial_delay: 1.0
      max_delay: 60.0
      backoff_multiplier: 2.0
      
    websocket:
      enabled: true
      url: "wss://stream.bybit.com/v5/public/spot"
      ping_interval: 30
      ping_timeout: 10
      reconnect_delay: 5
      max_reconnect_attempts: 10
      
    features:
      ohlcv: true
      orderbook: true
      trades: true
      ticker: true
      balance: true
      create_order: true
      cancel_order: true
      fetch_order: true

# ------------------------------------------------------------------------------
# DATABASE CONNECTORS
# ------------------------------------------------------------------------------
databases:
  postgresql:
    enabled: true
    name: "trading_analytics"
    
    # Connection Settings
    connection:
      host: "localhost"
      port: 5433
      database: "${POSTGRES_DB}"
      user: "${POSTGRES_USER}"
      password: "${POSTGRES_PASSWORD}"
      
    # Connection Pool
    pool:
      size: 10
      max_overflow: 20
      timeout: 30
      recycle: 3600  # 1 hour
      pre_ping: true
      
    # Performance Settings
    performance:
      statement_timeout: 30000  # 30 seconds
      idle_in_transaction_timeout: 60000  # 1 minute
      connect_timeout: 10
      
    # Tables
    tables:
      - trades
      - orders
      - balances
      - analytics
      - strategies
      
    # Features
    features:
      connection_pooling: true
      prepared_statements: true
      ssl: false
      
  redis:
    enabled: true
    name: "cache_and_pubsub"
    
    # Connection Settings
    connection:
      host: "localhost"
      port: 6379
      db: 0
      password: null
      ssl: false
      
    # Connection Pool
    pool:
      max_connections: 50
      min_idle: 5
      timeout: 5
      
    # Performance
    performance:
      socket_keepalive: true
      socket_timeout: 5
      retry_on_timeout: true
      max_retry: 3
      
    # Use Cases
    use_cases:
      - "ML model predictions cache"
      - "Real-time market data cache"
      - "Session management"
      - "Rate limiting"
      - "PubSub for notifications"
      
    # Namespaces
    namespaces:
      ml_predictions: "ml:predictions"
      market_data: "market:data"
      rate_limits: "ratelimit"
      sessions: "session"
      
    # TTL Settings (seconds)
    ttl:
      predictions: 300  # 5 minutes
      market_data: 60   # 1 minute
      sessions: 3600    # 1 hour

# ------------------------------------------------------------------------------
# WEBSOCKET STREAMS
# ------------------------------------------------------------------------------
websocket_streams:
  market_data:
    enabled: true
    exchange: "binance"
    
    # Subscriptions
    subscriptions:
      symbols:
        - "BTC/USDT"
        - "ETH/USDT"
        - "BNB/USDT"
      channels:
        - "ticker"
        - "trade"
        - "kline_1m"
        
    # Connection Settings
    connection:
      reconnect_delay: 1.0
      max_reconnect_delay: 60.0
      ping_interval: 30.0
      ping_timeout: 10.0
      
    # Buffer Settings
    buffer:
      max_queue_size: 10000
      drop_on_full: true
      
    # Health Monitoring
    health:
      check_interval: 30
      max_message_age: 30
      alert_on_stale: true
      
  orderbook_depth:
    enabled: false
    exchange: "binance"
    
    subscriptions:
      symbols:
        - "BTC/USDT"
      channels:
        - "depth20"
        
    connection:
      reconnect_delay: 1.0
      max_reconnect_delay: 60.0
      
    buffer:
      max_queue_size: 5000

# ------------------------------------------------------------------------------
# API ENDPOINTS
# ------------------------------------------------------------------------------
api_endpoints:
  freqtrade:
    enabled: true
    base_url: "http://127.0.0.1:8080"
    
    authentication:
      username: "${FREQTRADE_API_USERNAME}"
      password: "${FREQTRADE_API_PASSWORD}"
      
    endpoints:
      status: "/api/v1/status"
      profit: "/api/v1/profit"
      balance: "/api/v1/balance"
      trades: "/api/v1/trades"
      performance: "/api/v1/performance"
      
    timeout: 30
    retry:
      max_attempts: 3
      delay: 1.0
      
  telegram_bot:
    enabled: true
    
    connection:
      token: "${TELEGRAM_TOKEN}"
      chat_id: "${TELEGRAM_CHAT_ID}"
      
    features:
      notifications: true
      remote_control: true
      emergency_stop: true
      
    rate_limits:
      messages_per_second: 1
      messages_per_minute: 20
      
  jupyter_lab:
    enabled: true
    base_url: "http://127.0.0.1:8888"
    
    authentication:
      token: "${JUPYTER_TOKEN}"
      
    features:
      notebook_execution: true
      kernel_management: true

# ------------------------------------------------------------------------------
# HEALTH CHECKS
# ------------------------------------------------------------------------------
health_checks:
  enabled: true
  interval: 60  # seconds
  
  checks:
    - name: "binance_api"
      type: "exchange"
      target: "binance"
      method: "ping"
      timeout: 5
      
    - name: "binance_websocket"
      type: "websocket"
      target: "market_data"
      max_message_age: 30
      
    - name: "postgresql"
      type: "database"
      target: "postgresql"
      query: "SELECT 1"
      timeout: 5
      
    - name: "redis"
      type: "cache"
      target: "redis"
      command: "PING"
      timeout: 2
      
  alerts:
    on_failure: true
    channels:
      - "telegram"
      - "log"
    cooldown: 300  # 5 minutes between alerts

# ------------------------------------------------------------------------------
# MONITORING & METRICS
# ------------------------------------------------------------------------------
monitoring:
  enabled: true
  
  metrics:
    - exchange_requests_total
    - exchange_requests_failed
    - exchange_latency_ms
    - database_connections_active
    - database_query_time_ms
    - websocket_messages_received
    - websocket_reconnects_total
    - redis_cache_hits
    - redis_cache_misses
    
  exporters:
    prometheus:
      enabled: true
      port: 9090
      
    grafana:
      enabled: true
      dashboards:
        - "trading_overview"
        - "exchange_performance"
        - "database_metrics"

# ------------------------------------------------------------------------------
# CIRCUIT BREAKERS
# ------------------------------------------------------------------------------
circuit_breakers:
  exchange:
    enabled: true
    failure_threshold: 5
    success_threshold: 2
    timeout: 60  # seconds
    
  database:
    enabled: true
    failure_threshold: 3
    success_threshold: 2
    timeout: 30
    
  websocket:
    enabled: true
    failure_threshold: 10
    success_threshold: 3
    timeout: 120

# ------------------------------------------------------------------------------
# FALLBACK & REDUNDANCY
# ------------------------------------------------------------------------------
fallback:
  exchange:
    primary: "binance"
    fallback: []  # Add "bybit" if needed
    auto_switch: false
    
  data_source:
    primary: "websocket"
    fallback: "rest_api"
    auto_switch: true

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
